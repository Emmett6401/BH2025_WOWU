<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 MyPage - KDT교육관리시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- 헤더 -->
    <header class="bg-gradient-to-r from-green-600 to-teal-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <i class="fas fa-user-graduate text-3xl"></i>
                <div>
                    <h1 class="text-2xl font-bold">학생 MyPage</h1>
                    <p class="text-sm text-green-100">환영합니다, <span id="studentName"></span>님!</p>
                </div>
            </div>
            <button onclick="logout()" class="bg-white text-green-600 hover:bg-green-50 px-4 py-2 rounded-lg font-semibold transition-all">
                <i class="fas fa-sign-out-alt mr-2"></i>로그아웃
            </button>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- 프로필 카드 -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
                <!-- 프로필 헤더 -->
                <div class="bg-gradient-to-r from-green-600 to-teal-600 p-8 text-white text-center">
                    <div class="inline-block relative">
                        <img id="student-photo" 
                             src="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect fill=%27%23e5e7eb%27 width=%27200%27 height=%27200%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27Arial%27 font-size=%2714%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dominant-baseline=%27middle%27%3ENo Photo%3C/text%3E%3C/svg%3E" 
                             alt="프로필 사진" 
                             class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg mx-auto"
                             onerror="this.style.backgroundColor='#e5e7eb'">
                        <button onclick="document.getElementById('student-photo-input').click()" 
                                class="absolute bottom-0 right-0 bg-white text-green-600 rounded-full p-2 shadow-lg hover:bg-green-50">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <input type="file" id="student-photo-input" accept="image/*" class="hidden" onchange="uploadStudentPhoto(event)">
                    <p class="text-sm text-green-100 mt-3">클릭하여 프로필 사진 변경</p>
                    
                    <!-- 프로그래스바 -->
                    <div id="student-upload-progress" class="hidden mt-4 max-w-md mx-auto">
                        <div class="w-full bg-green-200 rounded-full h-2.5">
                            <div id="student-progress-bar" class="bg-white h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="student-progress-text" class="text-sm text-white mt-2 text-center">업로드 중... 0%</p>
                    </div>
                </div>

                <!-- 프로필 정보 -->
                <div class="p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-id-card mr-3 text-green-600"></i>
                        내 정보
                    </h2>
                    
                    <form id="student-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- 이름 -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-user mr-2 text-blue-500"></i>이름
                                </label>
                                <input type="text" id="student-name" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 bg-gray-50" readonly>
                            </div>
                            
                            <!-- 생년월일 -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-birthday-cake mr-2 text-pink-500"></i>생년월일
                                </label>
                                <input type="text" id="student-birth-date" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            
                            <!-- 성별 -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-venus-mars mr-2 text-purple-500"></i>성별
                                </label>
                                <select id="student-gender" 
                                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">선택</option>
                                    <option value="남">남</option>
                                    <option value="여">여</option>
                                </select>
                            </div>
                            
                            <!-- 연락처 -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-phone mr-2 text-yellow-500"></i>연락처
                                </label>
                                <input type="tel" id="student-phone" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        
                        <!-- 이메일 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-envelope mr-2 text-red-500"></i>이메일
                            </label>
                            <input type="email" id="student-email" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <!-- 주소 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-map-marker-alt mr-2 text-orange-500"></i>주소
                            </label>
                            <input type="text" id="student-address" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <!-- 관심분야 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-heart mr-2 text-pink-500"></i>관심분야
                            </label>
                            <input type="text" id="student-interests" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                   placeholder="관심 있는 분야를 입력하세요">
                        </div>
                        
                        <!-- 학력 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-graduation-cap mr-2 text-indigo-500"></i>학력
                            </label>
                            <input type="text" id="student-education" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                   placeholder="최종 학교/학년(졸업)">
                        </div>
                        
                        <!-- 자기소개 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-comment-dots mr-2 text-teal-500"></i>자기소개
                            </label>
                            <textarea id="student-introduction" rows="4"
                                      class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                      placeholder="자기소개를 입력하세요 (200자 내외)"></textarea>
                        </div>
                        
                        <!-- 파일 첨부 -->
                        <div class="border-t pt-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-paperclip mr-2 text-green-500"></i>사진 및 파일 첨부 (그림파일, PDF, HWP, PPT, Excel, Word, TXT 등)
                            </h4>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <button type="button" onclick="document.getElementById('student-file-input').click()" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                        <i class="fas fa-folder-open mr-2"></i>파일 선택
                                    </button>
                                    <button type="button" onclick="document.getElementById('student-camera-input').click()" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                                        <i class="fas fa-camera mr-2"></i>사진 촬영
                                    </button>
                                </div>
                                <input type="file" id="student-file-input" accept="image/*,.pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.hwp" multiple 
                                       onchange="uploadStudentFiles(event)" class="hidden">
                                <input type="file" id="student-camera-input" accept="image/*"  
                                       onchange="uploadStudentFiles(event)" class="hidden">
                                <div id="student-file-upload-progress" class="hidden mb-3">
                                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                        <p class="text-sm text-blue-800 mb-2">
                                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                                            서버에 업로드 후 자동 저장됩니다. 잠시만 기다리세요...
                                        </p>
                                        <div class="w-full bg-blue-200 rounded-full h-2">
                                            <div id="student-file-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="student-file-list" class="flex flex-col gap-2 mt-2"></div>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    첨부 파일: <span id="student-file-count">0</span>/20
                                </p>
                            </div>
                        </div>
                        
                        <!-- 저장 버튼 -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" onclick="saveStudentProfile()" 
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                                <i class="fas fa-save mr-2"></i>저장
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 과정 정보 카드 -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-book-open mr-3 text-green-600"></i>
                    수강 과정 정보
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center gap-3 p-4 bg-green-50 rounded-lg">
                        <i class="fas fa-chalkboard-teacher text-2xl text-green-600"></i>
                        <div>
                            <p class="text-sm text-gray-600">과정명</p>
                            <p class="font-semibold text-gray-800" id="course-name">-</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 p-4 bg-blue-50 rounded-lg">
                        <i class="fas fa-calendar-alt text-2xl text-blue-600"></i>
                        <div>
                            <p class="text-sm text-gray-600">교육기간</p>
                            <p class="font-semibold text-gray-800" id="course-period">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 커스텀 알림 모달 -->
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="alert-box rounded-lg p-4 shadow-lg max-w-md">
            <div class="flex items-center gap-3">
                <div class="alert-icon flex-shrink-0">
                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                </div>
                <p id="alert-message" class="text-gray-800 font-medium"></p>
            </div>
        </div>
    </div>

    <!-- 커스텀 확인 모달 -->
    <div id="custom-confirm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md mx-4">
            <div class="mb-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-3xl mt-1"></i>
                    <p id="confirm-message" class="text-gray-800 whitespace-pre-line"></p>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold">
                    <i class="fas fa-times mr-2"></i>취소
                </button>
                <button id="confirm-ok" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                    <i class="fas fa-check mr-2"></i>확인
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        const API_BASE_URL = '';
        
        // ==================== 커스텀 알림/확인 모달 ====================
        let alertTimer = null;
        
        window.showAlert = function(message, type = 'success') {
            const alertModal = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertIcon = alertModal.querySelector('.alert-icon');
            
            alertMessage.textContent = message;
            
            const alertBox = alertModal.querySelector('.alert-box');
            alertBox.className = 'alert-box rounded-lg p-4 shadow-lg max-w-md';
            
            if (type === 'success') {
                alertBox.classList.add('bg-green-50', 'border', 'border-green-200');
                alertMessage.classList.add('text-green-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-check-circle text-green-600 text-2xl"></i>';
                }
            } else if (type === 'error') {
                alertBox.classList.add('bg-red-50', 'border', 'border-red-200');
                alertMessage.classList.add('text-red-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>';
                }
            } else if (type === 'warning') {
                alertBox.classList.add('bg-yellow-50', 'border', 'border-yellow-200');
                alertMessage.classList.add('text-yellow-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>';
                }
            } else if (type === 'info') {
                alertBox.classList.add('bg-blue-50', 'border', 'border-blue-200');
                alertMessage.classList.add('text-blue-800');
                if (alertIcon) {
                    alertIcon.innerHTML = '<i class="fas fa-info-circle text-blue-600 text-2xl"></i>';
                }
            }
            
            alertModal.classList.remove('hidden');
            
            if (alertTimer) clearTimeout(alertTimer);
            alertTimer = setTimeout(() => {
                alertModal.classList.add('hidden');
            }, 3000);
            
            alertModal.onclick = () => {
                alertModal.classList.add('hidden');
                if (alertTimer) clearTimeout(alertTimer);
            };
        };
        
        window.showConfirm = function(message) {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('custom-confirm');
                const confirmMessage = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel');
                const okBtn = document.getElementById('confirm-ok');
                
                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');
                
                const cleanup = () => {
                    confirmModal.classList.add('hidden');
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                };
                
                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                okBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
            });
        };
        
        // URL에서 파일명 추출 (타임스탬프 패턴 제거)
        window.getFilenameFromUrl = function(url) {
            if (!url) return 'unknown';
            try {
                // 1. URL#원본파일명 형식에서 원본 파일명 추출
                if (url.includes('#')) {
                    const parts = url.split('#');
                    if (parts.length > 1 && parts[1]) {
                        return decodeURIComponent(parts[1]);
                    }
                }
                
                // 2. FTP URL에서 파일명 추출
                const parts = url.split('/');
                let filename = parts[parts.length - 1];
                
                // 3. 쿼리 파라미터 제거
                if (filename.includes('?')) {
                    filename = filename.split('?')[0];
                }
                
                // 4. 디코딩
                filename = decodeURIComponent(filename);
                
                // 5. 타임스탬프_UUID_ 패턴 제거
                const timestampPattern = /^\d{8}_\d{6}_[a-f0-9]{8}_(.+)$/;
                const match = filename.match(timestampPattern);
                if (match && match[1]) {
                    return match[1];
                }
                
                return filename;
            } catch (e) {
                return 'unknown';
            }
        };
        
        // URL에서 # 이후 제거 (실제 파일URL만 추출)
        window.getCleanUrl = function(url) {
            if (!url) return '';
            return url.split('#')[0];
        };
        
        // 페이지 로드 시 학생 정보 표시
        window.addEventListener('DOMContentLoaded', async () => {
            let student = JSON.parse(localStorage.getItem('student'));
            if (!student) {
                window.showAlert('로그인이 필요합니다.', 'error');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1000);
                return;
            }
            
            // 서버에서 최신 학생 정보 가져오기
            try {
                const response = await axios.get(`${API_BASE_URL}/api/students/${student.id}`);
                if (response.data) {
                    // 최신 정보로 업데이트
                    student = response.data;
                    
                    // localStorage도 업데이트 (비밀번호 제외)
                    const storedStudent = JSON.parse(localStorage.getItem('student'));
                    const updatedData = {
                        ...student,
                        password: storedStudent.password
                    };
                    localStorage.setItem('student', JSON.stringify(updatedData));
                }
            } catch (error) {
                console.error('최신 학생 정보 로드 실패:', error);
            }
            
            // 헤더에 이름 표시
            document.getElementById('studentName').textContent = student.name;
            
            // 폼에 정보 채우기
            document.getElementById('student-name').value = student.name || '';
            document.getElementById('student-birth-date').value = student.birth_date || '';
            document.getElementById('student-gender').value = student.gender || '';
            document.getElementById('student-phone').value = student.phone || '';
            document.getElementById('student-email').value = student.email || '';
            document.getElementById('student-address').value = student.address || '';
            document.getElementById('student-interests').value = student.interests || '';
            document.getElementById('student-education').value = student.education || '';
            document.getElementById('student-introduction').value = student.introduction || '';
            
            // 프로필 사진
            if (student.profile_photo) {
                document.getElementById('student-photo').src = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(student.profile_photo);
            }
            
            // 첨부 파일 목록
            if (student.attachments) {
                try {
                    const attachments = JSON.parse(student.attachments);
                    if (attachments && attachments.length > 0) {
                        // 파일 미리보기 표시
                        updateStudentFilePreview(attachments);
                        // 파일 개수 업데이트
                        const fileCountSpan = document.getElementById('student-file-count');
                        if (fileCountSpan) {
                            fileCountSpan.textContent = attachments.length;
                        }
                    }
                } catch (e) {
                    console.error('첨부 파일 로드 실패:', e);
                }
            }
            
            // 과정 정보
            document.getElementById('course-name').textContent = student.course_name || '미배정';
            if (student.start_date && student.end_date) {
                document.getElementById('course-period').textContent = `${student.start_date} ~ ${student.end_date}`;
            }
        });
        
        // 프로필 사진 업로드
        window.uploadStudentPhoto = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            const progressContainer = document.getElementById('student-upload-progress');
            const progressBar = document.getElementById('student-progress-bar');
            const progressText = document.getElementById('student-progress-text');
            
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '업로드 중... 0%';
            
            try {
                const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=student`, formData, {
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        progressBar.style.width = percentCompleted + '%';
                        progressText.textContent = `업로드 중... ${percentCompleted}%`;
                    }
                });
                
                const photoUrl = response.data.url;
                document.getElementById('student-photo').src = API_BASE_URL + '/api/thumbnail?url=' + encodeURIComponent(photoUrl);
                
                progressBar.style.width = '100%';
                progressText.textContent = '✅ 업로드 완료!';
                
                // 자동 저장
                const student = JSON.parse(localStorage.getItem('student'));
                if (student && student.id) {
                    await saveStudentProfileSilent(photoUrl);
                    window.showAlert('✅ 프로필 사진이 업로드되고 자동 저장되었습니다!', 'success');
                } else {
                    window.showAlert('✅ 프로필 사진이 업로드되었습니다!', 'success');
                }
                
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('사진 업로드 실패:', error);
                progressText.textContent = '❌ 업로드 실패';
                window.showAlert('❌ 사진 업로드에 실패했습니다: ' + error.message, 'error');
                
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 2000);
            }
        };
        
        // 파일 아이콘 반환
        function getFileIcon(extension) {
            const iconMap = {
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'docx': 'fas fa-file-word',
                'xls': 'fas fa-file-excel',
                'xlsx': 'fas fa-file-excel',
                'ppt': 'fas fa-file-powerpoint',
                'pptx': 'fas fa-file-powerpoint',
                'txt': 'fas fa-file-alt',
                'hwp': 'fas fa-file-alt',
                'zip': 'fas fa-file-archive',
                'rar': 'fas fa-file-archive'
            };
            return iconMap[extension] || 'fas fa-file';
        }
        
        // 파일 업로드 (첨부 파일 - 최대 20개)
        window.uploadStudentFiles = async function(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const student = JSON.parse(localStorage.getItem('student'));
            const progressDiv = document.getElementById('student-file-upload-progress');
            const progressBar = document.getElementById('student-file-progress-bar');
            
            try {
                // 기존 첨부 파일 가져오기
                let attachments = [];
                if (student.attachments) {
                    try {
                        attachments = JSON.parse(student.attachments);
                    } catch (e) {
                        attachments = [];
                    }
                }
                
                // 파일 개수 제한 체크 (최대 20개)
                const remainingSlots = 20 - attachments.length;
                if (remainingSlots <= 0) {
                    window.showAlert('⚠️ 첨부 파일은 최대 20개까지만 업로드할 수 있습니다.', 'warning');
                    event.target.value = '';
                    return;
                }
                
                if (files.length > remainingSlots) {
                    window.showAlert(`⚠️ ${remainingSlots}개의 파일만 업로드할 수 있습니다. (현재: ${attachments.length}/20)`, 'warning');
                    event.target.value = '';
                    return;
                }
                
                progressDiv.classList.remove('hidden');
                progressBar.style.width = '0%';
                
                // 파일 업로드
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await axios.post(`${API_BASE_URL}/api/upload-image?category=student`, formData, {
                        onUploadProgress: (progressEvent) => {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            progressBar.style.width = percentCompleted + '%';
                        }
                    });
                    
                    // URL과 원본 파일명을 함께 저장 (URL#원본파일명 형식)
                    const urlWithOriginalName = response.data.original_filename 
                        ? `${response.data.url}#${encodeURIComponent(response.data.original_filename)}`
                        : response.data.url;
                    attachments.push(urlWithOriginalName);
                }
                
                // 미리보기 업데이트
                updateStudentFilePreview(attachments);
                
                // 프로필 사진 URL 가져오기
                const profilePhoto = document.getElementById('student-photo').src.includes('/api/thumbnail')
                    ? new URLSearchParams(document.getElementById('student-photo').src.split('?')[1]).get('url')
                    : student.profile_photo;
                
                // 자동 저장 - JSON 데이터 사용
                const updateData = {
                    name: student.name,
                    birth_date: document.getElementById('student-birth-date').value || '',
                    gender: document.getElementById('student-gender').value || '',
                    phone: document.getElementById('student-phone').value || '',
                    email: document.getElementById('student-email').value || '',
                    address: document.getElementById('student-address').value || '',
                    interests: document.getElementById('student-interests').value || '',
                    education: document.getElementById('student-education').value || '',
                    introduction: document.getElementById('student-introduction').value || '',
                    campus: student.campus || '',
                    course_code: student.course_code || '',
                    notes: student.notes || '',
                    career_path: student.career_path || '4. 미정',
                    profile_photo: profilePhoto,
                    attachments: JSON.stringify(attachments)
                };
                
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // 로컬스토리지 업데이트
                student.attachments = JSON.stringify(attachments);
                localStorage.setItem('student', JSON.stringify(student));
                
                // 파일 개수 업데이트
                const fileCountSpan = document.getElementById('student-file-count');
                if (fileCountSpan) {
                    fileCountSpan.textContent = attachments.length;
                }
                
                progressBar.style.width = '100%';
                window.showAlert(`✅ ${files.length}개 파일이 업로드되고 자동 저장되었습니다! (${attachments.length}/20)`, 'success');
                
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('파일 업로드 실패:', error);
                progressDiv.classList.add('hidden');
                window.showAlert('❌ 파일 업로드에 실패했습니다: ' + error.message, 'error');
            }
            
            // 파일 input 초기화
            event.target.value = '';
        };
        
        // 파일 미리보기 업데이트
        function updateStudentFilePreview(photoUrls) {
            const previewDiv = document.getElementById('student-file-list');
            if (!previewDiv) return;
            
            previewDiv.innerHTML = '';
            
            photoUrls.forEach((url, index) => {
                const fileExt = url.split('.').pop().toLowerCase();
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt);
                
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center gap-3 p-3 bg-white rounded border hover:shadow-md transition';
                
                if (isImage) {
                    fileDiv.innerHTML = `
                        <img src="${API_BASE_URL}/api/thumbnail?url=${encodeURIComponent(url)}" 
                             alt="파일 ${index + 1}" 
                             class="w-16 h-16 object-cover rounded border"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2764%27 height=%2764%27%3E%3Crect fill=%27%23f0f0f0%27 width=%2764%27 height=%2764%27/%3E%3Ctext fill=%27%23999%27 font-family=%27sans-serif%27 font-size=%2712%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EError%3C/text%3E%3C/svg%3E'">
                        <div class="flex-1">
                            <p class="text-sm text-gray-800 font-medium truncate" title="${window.getFilenameFromUrl(url)}">${window.getFilenameFromUrl(url)}</p>
                            <a href="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                               target="_blank" 
                               class="text-xs text-blue-500 hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>보기
                            </a>
                        </div>
                        <button type="button" 
                                onclick="removeStudentFile(${index})" 
                                class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times-circle text-xl"></i>
                        </button>
                    `;
                } else {
                    const icon = getFileIcon(fileExt);
                    fileDiv.innerHTML = `
                        <div class="w-16 h-16 flex items-center justify-center bg-gray-100 rounded border">
                            <i class="${icon} text-3xl text-gray-500"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-800 font-medium truncate" title="${window.getFilenameFromUrl(url)}">${window.getFilenameFromUrl(url)}</p>
                            <a href="${API_BASE_URL}/api/download-image?url=${encodeURIComponent(url)}" 
                               target="_blank" 
                               class="text-xs text-blue-500 hover:underline">
                                <i class="fas fa-download mr-1"></i>다운로드
                            </a>
                        </div>
                        <button type="button" 
                                onclick="removeStudentFile(${index})" 
                                class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times-circle text-xl"></i>
                        </button>
                    `;
                }
                
                previewDiv.appendChild(fileDiv);
            });
        }
        
        // 파일 삭제
        window.removeStudentFile = async function(index) {
            if (!confirm('이 파일을 삭제하시겠습니까?')) return;
            
            const student = JSON.parse(localStorage.getItem('student'));
            const photoUrlsInput = document.getElementById('student-photo-urls-hidden');
            let photoUrls = JSON.parse(photoUrlsInput.value || '[]');
            
            // 기존 photo_urls 가져오기
            if (!photoUrls.length && student.photo_urls) {
                try {
                    photoUrls = JSON.parse(student.photo_urls);
                } catch (e) {
                    photoUrls = [];
                }
            }
            
            attachments.splice(index, 1);
            
            // 미리보기 업데이트
            updateStudentFilePreview(attachments);
            
            // 자동 저장 - JSON 데이터 사용
            try {
                // 프로필 사진 URL 가져오기
                const profilePhoto = document.getElementById('student-photo').src.includes('/api/thumbnail')
                    ? new URLSearchParams(document.getElementById('student-photo').src.split('?')[1]).get('url')
                    : student.profile_photo;
                
                const updateData = {
                    name: student.name,
                    birth_date: document.getElementById('student-birth-date').value || '',
                    gender: document.getElementById('student-gender').value || '',
                    phone: document.getElementById('student-phone').value || '',
                    email: document.getElementById('student-email').value || '',
                    address: document.getElementById('student-address').value || '',
                    interests: document.getElementById('student-interests').value || '',
                    education: document.getElementById('student-education').value || '',
                    introduction: document.getElementById('student-introduction').value || '',
                    campus: student.campus || '',
                    course_code: student.course_code || '',
                    notes: student.notes || '',
                    career_path: student.career_path || '4. 미정',
                    profile_photo: profilePhoto,
                    attachments: JSON.stringify(attachments)
                };
                
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // 로컬스토리지 업데이트
                student.attachments = JSON.stringify(attachments);
                localStorage.setItem('student', JSON.stringify(student));
                
                // 파일 개수 업데이트
                const fileCountSpan = document.getElementById('student-file-count');
                if (fileCountSpan) {
                    fileCountSpan.textContent = attachments.length;
                }
                
                // 캐시 삭제
                localStorage.removeItem('cache_students');
                
                window.showAlert(`✅ 파일이 삭제되고 자동 저장되었습니다! (${attachments.length}/20)`, 'success');
            } catch (error) {
                console.error('파일 삭제 실패:', error);
                alert('❌ 파일 삭제에 실패했습니다: ' + error.message);
            }
        };
        
        // 프로필 사진 자동 저장 (Silent)
        async function saveStudentProfileSilent(profilePhotoUrl) {
            const student = JSON.parse(localStorage.getItem('student'));
            
            // 첨부 파일 가져오기
            let attachments = [];
            if (student.attachments) {
                try {
                    attachments = JSON.parse(student.attachments);
                } catch (e) {
                    attachments = [];
                }
            }
            
            // JSON 데이터 준비
            const updateData = {
                name: student.name,
                birth_date: document.getElementById('student-birth-date').value || '',
                gender: document.getElementById('student-gender').value || '',
                phone: document.getElementById('student-phone').value || '',
                email: document.getElementById('student-email').value || '',
                address: document.getElementById('student-address').value || '',
                interests: document.getElementById('student-interests').value || '',
                education: document.getElementById('student-education').value || '',
                introduction: document.getElementById('student-introduction').value || '',
                campus: student.campus || '',
                course_code: student.course_code || '',
                notes: student.notes || '',
                career_path: student.career_path || '4. 미정',
                profile_photo: profilePhotoUrl,
                attachments: JSON.stringify(attachments)
            };
            
            try {
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // 로컬 스토리지 업데이트
                student.profile_photo = profilePhotoUrl;
                localStorage.setItem('student', JSON.stringify(student));
                
                // 캐시 삭제
                localStorage.removeItem('cache_students');
            } catch (error) {
                console.error('자동 저장 실패:', error);
                throw error;
            }
        }
        
        // 학생 정보 저장
        window.saveStudentProfile = async function() {
            const student = JSON.parse(localStorage.getItem('student'));
            
            // 프로필 사진 URL
            const photoImg = document.getElementById('student-photo');
            let profilePhoto = student.profile_photo;
            if (photoImg.src.includes('/api/thumbnail')) {
                const urlParam = new URLSearchParams(photoImg.src.split('?')[1]);
                const ftpUrl = urlParam.get('url');
                if (ftpUrl) {
                    profilePhoto = ftpUrl;
                }
            }
            
            // 첨부 파일 가져오기
            let attachments = [];
            if (student.attachments) {
                try {
                    attachments = JSON.parse(student.attachments);
                } catch (e) {
                    attachments = [];
                }
            }
            
            // JSON 데이터 준비
            const updateData = {
                name: document.getElementById('student-name').value,
                birth_date: document.getElementById('student-birth-date').value || '',
                gender: document.getElementById('student-gender').value || '',
                phone: document.getElementById('student-phone').value || '',
                email: document.getElementById('student-email').value || '',
                address: document.getElementById('student-address').value || '',
                interests: document.getElementById('student-interests').value || '',
                education: document.getElementById('student-education').value || '',
                introduction: document.getElementById('student-introduction').value || '',
                campus: student.campus || '',
                course_code: student.course_code || '',
                notes: student.notes || '',
                career_path: student.career_path || '4. 미정',
                profile_photo: profilePhoto,
                attachments: JSON.stringify(attachments)
            };
            
            try {
                await axios.put(`${API_BASE_URL}/api/students/${student.id}`, updateData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // 로컬 스토리지 업데이트
                student.birth_date = document.getElementById('student-birth-date').value;
                student.gender = document.getElementById('student-gender').value;
                student.phone = document.getElementById('student-phone').value;
                student.email = document.getElementById('student-email').value;
                student.address = document.getElementById('student-address').value;
                student.interests = document.getElementById('student-interests').value;
                student.education = document.getElementById('student-education').value;
                student.introduction = document.getElementById('student-introduction').value;
                localStorage.setItem('student', JSON.stringify(student));
                
                // 캐시 삭제
                localStorage.removeItem('cache_students');
                
                window.showAlert('✅ 정보가 저장되었습니다!', 'success');
            } catch (error) {
                console.error('저장 실패:', error);
                window.showAlert('저장에 실패했습니다: ' + (error.response?.data?.detail || error.message), 'error');
            }
        };
        
        // 로그아웃
        window.logout = function() {
            // 커스텀 확인 모달
            const student = JSON.parse(localStorage.getItem('student') || '{}');
            const studentName = student.name || '학생';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center">
                    <div class="mb-6">
                        <i class="fas fa-sign-out-alt text-6xl text-green-600 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">로그아웃</h3>
                        <p class="text-gray-600 mb-1">${studentName}님,</p>
                        <p class="text-gray-600">로그아웃 하시겠습니까?</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="logout-cancel" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                            <i class="fas fa-times mr-2"></i>취소
                        </button>
                        <button id="logout-confirm" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                            <i class="fas fa-check mr-2"></i>확인
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('logout-cancel').onclick = () => modal.remove();
            document.getElementById('logout-confirm').onclick = () => {
                localStorage.removeItem('student');
                localStorage.removeItem('user_type');
                localStorage.removeItem('logged_in');
                window.location.href = '/login.html';
            };
        };
    </script>
</body>
</html>
